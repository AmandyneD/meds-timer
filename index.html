<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Meds Timer (Ibuprofen / Paracetamol)</title>
<style>
  :root { --bg:#0b0c10; --card:#151821; --accent:#77dd77; --text:#f5f7fa; --muted:#b7c0cc; }
  html,body{height:100%} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:820px;margin:auto;padding:16px}
  h1{font-size:1.4rem;margin:8px 0 12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .card h2{margin:0 0 10px;font-size:1.1rem}
  label{font-size:.95rem}
  input,select,button{font-size:1rem;padding:10px 12px;border-radius:10px;border:1px solid #2a2f3a;background:#0f1220;color:var(--text)}
  select{background:#0f1220}
  button{cursor:pointer;border:0;background:#2b3244}
  .primary{background:var(--accent);color:#062; font-weight:700}
  .danger{background:#ff6b6b;color:#340}
  .ghost{background:transparent;border:1px dashed #3a4454}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .big{font-size:1.8rem;font-weight:800}
  .muted{color:var(--muted);font-size:.9rem}
  .pill{display:inline-block;padding:2px 8px;border-radius:20px;background:#203; margin-left:8px;font-size:.8rem}
  .ok{background:#153f2a}
  .warn{background:#3f2a15}
  .bar{height:10px;background:#0f1220;border-radius:999px;overflow:hidden}
  .bar > span{display:block;height:100%;background:var(--accent);width:0%}
  .list{max-height:200px;overflow:auto;border:1px solid #2a2f3a;border-radius:12px;padding:8px}
  .item{display:flex;justify-content:space-between;padding:6px 8px;border-bottom:1px solid #232836}
  .item:last-child{border-bottom:0}
  .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
</style>
</head>
<body>
<div class="wrap">
  <h1>üïí Meds Timer ‚Äî Ibuprofen / Paracetamol (6h)</h1>

  <!-- Profiles -->
  <div class="card">
    <h2>Children</h2>
    <div class="row">
      <select id="childSelect" aria-label="Select child"></select>
      <input id="newChild" placeholder="Add child name‚Ä¶" aria-label="Child name" />
      <button id="addChild" class="primary">Add</button>
      <button id="delChild" class="danger">Delete</button>
      <button id="exportBtn" title="Share data with partner">Export</button>
      <label class="ghost" style="display:inline-block;">
        <input id="importFile" type="file" accept="application/json" class="sr-only" />
        <span style="padding:10px 12px;display:inline-block">Import</span>
      </label>
    </div>
    <p class="muted" id="childMeta"></p>
  </div>

  <!-- Actions -->
  <div class="row">
    <div class="card" style="flex:1 1 360px">
      <h2>Dose</h2>
      <div class="grid" role="group" aria-label="Medicine and time">
        <label>Medicine
          <select id="medType">
            <option>Ibuprofen</option>
            <option>Paracetamol</option>
          </select>
        </label>
        <label>Manual time
          <input id="manualTime" type="datetime-local" />
        </label>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="takeNow" class="primary">Take now</button>
        <button id="addManual">Add manual entry</button>
        <button id="undo" class="ghost">Undo last dose</button>
      </div>
      <p class="muted">Minimum interval is fixed at <b>6 hours</b>. Max/day logic can be added later if needed.</p>
    </div>

    <div class="card" style="flex:1 1 360px">
      <h2>Status</h2>
      <div class="big" id="countdown">‚Äî:‚Äî</div>
      <div class="muted" id="nextTime">Next dose: ‚Äî</div>
      <div class="bar" aria-hidden="true" style="margin-top:10px"><span id="progress"></span></div>
      <div style="margin-top:8px">
        <span id="okBadge" class="pill ok" hidden>‚úì Safe to dose</span>
        <span id="waitBadge" class="pill warn" hidden>‚è≥ Wait</span>
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="card">
    <h2>History</h2>
    <div id="history" class="list" role="log" aria-live="polite"></div>
  </div>
</div>

<script>
/* ========= Storage & State ========= */
const SIX_HOURS = 6 * 60 * 60 * 1000;
const $ = sel => document.querySelector(sel);
const storeKey = "meds-timer-v1";

function loadState(){
  try{ return JSON.parse(localStorage.getItem(storeKey)) || { children: {} }; }
  catch{ return { children: {} }; }
}
function saveState(){ localStorage.setItem(storeKey, JSON.stringify(state)); }
let state = loadState();

function ensureChild(name){
  if(!state.children[name]) state.children[name] = { doses: [] };
}

/* ========= UI Helpers ========= */
function formatTime(ts){
  if(!ts) return "‚Äî";
  const d = new Date(ts);
  return d.toLocaleString();
}
function humanCountdown(ms){
  if(ms <= 0) return "00:00";
  const total = Math.ceil(ms/1000);
  const h = Math.floor(total/3600);
  const m = Math.floor((total%3600)/60);
  const hh = String(h).padStart(2,"0");
  const mm = String(m).padStart(2,"0");
  return `${hh}:${mm}`;
}
function setBadges(canDose){
  $("#okBadge").hidden = !canDose;
  $("#waitBadge").hidden = canDose;
}

/* ========= Children UI ========= */
const childSelect = $("#childSelect");
function refreshChildrenUI(){
  const names = Object.keys(state.children);
  childSelect.innerHTML = names.map(n => `<option>${n}</option>`).join("");
  if(!names.length) return;
  if(!names.includes(state.current)) state.current = names[0];
  childSelect.value = state.current;
  updateChildMeta();
  renderStatus();
  renderHistory();
}
function updateChildMeta(){
  const c = state.current;
  const doses = state.children[c]?.doses || [];
  $("#childMeta").textContent = c ? `${c} ¬∑ ${doses.length} recorded dose(s)` : "No child selected";
}

/* ========= Dose Logic ========= */
function recordDose(ts, med){
  const c = state.current; if(!c) return;
  state.children[c].doses.unshift({ ts, med }); // newest first
  saveState();
  renderStatus(); renderHistory();
  notify(`Dose recorded for ${c}: ${med}. Next in 6h.`);
}

function undoDose(){
  const c = state.current; if(!c) return;
  state.children[c].doses.shift();
  saveState(); renderStatus(); renderHistory();
}

function nextAllowedTime(){
  const c = state.current; if(!c) return null;
  const last = state.children[c].doses[0];
  if(!last) return null;
  return last.ts + SIX_HOURS;
}

function canDoseNow(){
  const t = nextAllowedTime();
  if(t === null) return true;
  return Date.now() >= t;
}

/* ========= Rendering ========= */
let ticker = null;
function renderStatus(){
  const next = nextAllowedTime();
  if(next === null){
    $("#countdown").textContent = "Ready";
    $("#nextTime").textContent = "Next dose: anytime";
    $("#progress").style.width = "100%";
    setBadges(true);
  } else {
    const diff = next - Date.now();
    $("#countdown").textContent = humanCountdown(diff);
    $("#nextTime").textContent = "Next dose: " + formatTime(next);
    const last = state.children[state.current].doses[0].ts;
    const elapsed = Date.now() - last;
    const pct = Math.max(0, Math.min(100, Math.round((elapsed / SIX_HOURS)*100)));
    $("#progress").style.width = pct + "%";
    setBadges(diff <= 0);
  }
  // ticker
  if(ticker) clearInterval(ticker);
  ticker = setInterval(()=>{
    const next = nextAllowedTime();
    if(next === null){
      $("#countdown").textContent = "Ready";
      $("#progress").style.width = "100%";
      setBadges(true);
      return;
    }
    const diff = next - Date.now();
    $("#countdown").textContent = humanCountdown(diff);
    const last = state.children[state.current].doses[0].ts;
    const elapsed = Date.now() - last;
    const pct = Math.max(0, Math.min(100, Math.round((elapsed / SIX_HOURS)*100)));
    $("#progress").style.width = pct + "%";
    setBadges(diff <= 0);
  }, 30_000); // update every 30s
}

function renderHistory(){
  const c = state.current; const box = $("#history");
  box.innerHTML = "";
  if(!c){ box.textContent = "No child selected."; return; }
  const doses = state.children[c].doses;
  if(!doses.length){ box.textContent = "No doses yet."; return; }
  doses.forEach(d=>{
    const row = document.createElement("div"); row.className="item";
    row.innerHTML = `<span>${d.med}</span><span class="muted">${formatTime(d.ts)}</span>`;
    box.appendChild(row);
  });
}

/* ========= Notifications ========= */
function notify(text){
  try{
    if(Notification.permission === "granted"){ new Notification(text); }
  }catch(e){}
}
(async function askNotif(){
  try{
    if("Notification" in window && Notification.permission === "default"){
      await Notification.requestPermission();
    }
  }catch(e){}
})();

/* ========= Events ========= */
$("#addChild").addEventListener("click", ()=>{
  const name = $("#newChild").value.trim();
  if(!name) return;
  ensureChild(name); state.current = name; $("#newChild").value="";
  saveState(); refreshChildrenUI();
});
$("#delChild").addEventListener("click", ()=>{
  const c = state.current; if(!c) return;
  if(confirm(`Delete ${c} and its history?`)){
    delete state.children[c]; state.current = Object.keys(state.children)[0] || null;
    saveState(); refreshChildrenUI();
  }
});
childSelect.addEventListener("change", e=>{ state.current = e.target.value; saveState(); refreshChildrenUI(); });

$("#takeNow").addEventListener("click", ()=>{
  if(!state.current) return alert("Add a child first.");
  const med = $("#medType").value;
  recordDose(Date.now(), med);
});
$("#addManual").addEventListener("click", ()=>{
  if(!state.current) return alert("Add a child first.");
  const val = $("#manualTime").value; if(!val) return alert("Pick a date & time.");
  const ts = new Date(val).getTime();
  if(Number.isNaN(ts)) return alert("Invalid datetime.");
  recordDose(ts, $("#medType").value);
});
$("#undo").addEventListener("click", ()=>{ undoDose(); });

/* ========= Export / Import ========= */
$("#exportBtn").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "meds-timer-data.json";
  a.click();
  URL.revokeObjectURL(a.href);
});
$("#importFile").addEventListener("change", async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text();
  try{
    const incoming = JSON.parse(txt);
    if(!incoming.children) throw new Error("Invalid file.");
    state = incoming; saveState(); refreshChildrenUI();
    alert("Data imported.");
  }catch(err){
    alert("Import failed: " + err.message);
  } finally {
    e.target.value = "";
  }
});

/* ========= Boot ========= */
(function init(){
  // Seed example for first run
  if(Object.keys(state.children).length === 0){
    ensureChild("Child A");
    state.current = "Child A";
    saveState();
  }
  refreshChildrenUI();
})();
</script>
</body>
</html>
